# AVDownloader - 视频爬取下载工具

## 📄 法律声明
### 版权信息
- 本程序仅用于个人学习和研究目的
- 请勿用于商业用途或非法活动
### 使用条款
- 使用本程序即表示您同意遵守相关法律法规
- 程序开发者不对因使用本程序而产生的任何后果负责
- 请尊重视频版权，仅下载您有权使用的内容

## 📖 项目简介

AVDownloader是一款功能强大的视频爬取下载工具，支持对网站动态视频资源的自动爬取与本地保存。特别支持M3U8播放列表的TS分片自动合并、getmovie链接的处理以及批量URL下载管理。

### ✨ 主要特性
- **自动下载模式**：一键自动探测并下载视频资源
- **批量URL管理**：支持添加多个网址，批量处理
- **智能资源检测**：优先检测getmovie链接，其次检测唯一m3u8文件
- **实时状态更新**：下载失败或成功时立即更新状态
- **下载历史记录**：避免重复下载已下载的网址
- **手动下载选项**：对于复杂资源提供手动选择下载
- **TS分片处理**：自动下载、解密和合并TS格式视频分片
- **直观的用户界面**：基于PyQt5构建的现代化界面
- **日志记录系统**：详细记录下载过程和错误信息
- **断点续传支持**：支持下载中断后恢复任务

## 📁 项目结构

```
AVDownloaderWithQTCpp/
├── AVDownloader/             # 源代码目录
│   ├── main.py                # 主程序入口
│   ├── browser_simulator.py   # 浏览器模拟模块
│   ├── video_detector.py      # 视频资源探测模块
│   ├── video_downloader.py    # 视频下载模块
│   ├── ts_merger.py           # TS分片合并模块
│   ├── utils.py               # 工具函数
│   ├── decrypt_existing.py    # 现有TS文件解密工具
│   ├── download_state_manager.py  # 下载状态管理模块
│   ├── build_exe.py           # 打包脚本
│   ├── build_exe_simple.py    # 简单打包脚本
│   ├── test_browser.py        # 浏览器测试脚本
│   ├── test_ts_download.py    # TS下载测试脚本
│   ├── requirements.txt       # 依赖库配置
│   └── Resources/             # 资源目录（包含密钥文件和Chrome安装程序）
├── dist/                      # 打包输出目录
│   ├── AVDownloader.exe       # 可执行文件
│   ├── Resources/             # 资源目录
│   │   ├── logs/              # 日志文件目录
│   │   │   └── downloader.log # 下载日志文件
│   │   ├── ChromeSetup.exe    # Chrome安装程序
│   │   └── download_state.ini # 下载状态配置文件
│   ├── Utils/                 # 工具目录
│   │   └── ffmpeg.exe         # FFmpeg工具
│   ├── 此程序依赖chrome浏览器，会自动安装.txt  # Chrome依赖说明
│   └── 用户须知.txt           # 用户使用说明
├── README.md                  # 项目说明
└── LICENSE.md                 # 许可证文件
```

## 🚀 快速开始

### 直接运行
1. **下载打包版本**：从 `dist/AVDownloader.exe` 直接运行
2. **首次运行**：程序会自动检查Chrome浏览器和FFmpeg工具
3. **Chrome安装**：如果未安装Chrome，程序会自动启动安装流程
4. **FFmpeg检查**：确保 `Utils/ffmpeg.exe` 存在

### 从源码运行
1. **安装依赖**：
   ```bash
   pip install -r AVDownloader\requirements.txt
   ```

2. **运行程序**：
   ```bash
   python AVDownloader\main.py
   ```

### 打包程序
1. **运行打包脚本**：
   ```bash
   python AVDownloader\build_exe.py
   ```

2. **打包结果**：
   - 生成的可执行文件位于 `dist/AVDownloader.exe`
   - 包含必要的资源文件和工具

## 🎯 核心功能

### 1. URL列表管理
- **添加URL**：点击"添加"按钮添加单个URL
- **删除URL**：选中URL后点击"删除"按钮
- **清空列表**：点击"清空"按钮清空所有URL
- **删除已成功**：点击"删除已成功"按钮删除所有下载成功的URL

### 2. 自动下载模式
- **智能资源检测**：
  1. 优先检测getmovie链接，如有则使用特殊解密方法下载
  2. 如无getmovie链接，检测是否有唯一的m3u8文件，如有则自动下载
  3. 如无唯一的m3u8文件，标记为需要手动下载
- **批量处理**：自动处理列表中的所有URL
- **状态更新**：实时更新每个URL的下载状态（待处理、下载中、成功、失败）
- **历史记录**：自动记录已下载的URL，避免重复下载

### 3. 手动下载功能
- **手动选择**：对于复杂资源，可手动选择要下载的视频资源
- **灵活控制**：用户可以根据需要选择适合的视频质量和格式

### 4. 视频处理
- **TS分片合并**：自动下载、解密和合并TS格式视频分片
- **格式转换**：使用FFmpeg将TS分片合并为完整的MP4文件
- **加密处理**：支持从网络或本地资源目录获取密钥解密加密视频

### 5. 进度与状态管理
- **实时进度**：底部进度条显示下载进度
- **详细日志**：控制台输出区域显示详细的下载信息
- **状态显示**：每个URL旁边显示当前下载状态
- **日志文件**：自动记录下载日志到 `Resources/logs/downloader.log`

## 🛠️ 技术实现

### 核心技术
- **GUI框架**：PyQt5，构建现代化的用户界面
- **浏览器模拟**：Selenium + Chrome，支持JavaScript渲染和动态资源加载
- **视频资源识别**：智能算法提取页面中的视频链接，特别支持getmovie链接
- **并行处理**：使用concurrent.futures.ThreadPoolExecutor实现多线程并行下载
- **视频处理**：FFmpeg工具合并TS分片为完整的MP4文件
- **网络处理**：requests库发送HTTP请求，支持自定义headers和cookies
- **文件处理**：自动创建和管理临时目录，确保文件结构清晰
- **状态管理**：使用配置文件管理下载状态，支持断点续传

### 核心模块
1. **MainWindow**：主窗口类，负责界面管理和用户交互
2. **SyncBrowserSimulator**：浏览器模拟器，负责加载页面和提取视频资源
3. **VideoDetector**：视频检测器，负责识别和提取视频链接
4. **VideoDownloader**：视频下载器，负责下载普通视频文件
5. **TSMerger**：TS合并器，负责下载、解密和合并TS分片
6. **DownloadStateManager**：下载状态管理器，负责记录和恢复下载任务
7. **WorkerThread**：工作线程，负责在后台执行耗时操作

## 📖 使用指南

### 基本操作流程
1. **添加URL**：点击"添加"按钮，在弹出的对话框中输入视频网址
2. **设置保存路径**：点击"浏览"按钮选择视频文件的保存位置
3. **开始自动下载**：点击"自动下载"按钮，程序会自动处理列表中的所有URL
4. **查看下载状态**：观察URL列表中的状态显示，了解每个URL的下载情况
5. **清理已成功下载**：点击"删除已成功"按钮，清理已下载完成的URL
6. **手动下载**：对于标记为需要手动下载的URL，点击"手动下载"按钮进行处理

### 高级功能
1. **批量添加URL**：可以通过复制粘贴的方式批量添加多个URL
2. **下载历史管理**：程序会自动记录已下载的URL，避免重复下载
3. **临时文件处理**：程序启动时会检测临时下载文件，可选择合并或删除
4. **加密视频处理**：对于加密的视频，程序会自动从网络或本地资源目录获取密钥进行解密
5. **日志管理**：程序会自动记录下载日志，方便排查问题

## ⚠️ 注意事项

### 依赖要求
1. **Chrome浏览器**：用于Selenium浏览器模拟和页面加载
2. **FFmpeg工具**：用于TS分片合并，必须位于 `Utils/ffmpeg.exe`
3. **Python 3.7+**：用于运行源代码

### 安全提示
1. **网络连接**：确保网络连接稳定，避免下载过程中网络中断
2. **网站限制**：部分网站可能对视频下载有限制，如需要登录、验证码等，本工具可能无法处理这些情况
3. **权限问题**：确保程序有足够的权限访问保存路径和资源目录
4. **性能优化**：对于大型视频或多个TS分片的情况，下载时间可能较长，请耐心等待
5. **版权尊重**：请遵守相关法律法规，尊重视频版权，仅下载您有权使用的内容

### 常见问题
1. **无法探测到视频资源**：
   - 检查URL是否正确
   - 确保网络连接正常
   - 部分网站可能使用了加密或特殊的视频播放方式，本工具可能无法识别

2. **下载失败**：
   - 检查网络连接是否稳定
   - 确保保存路径有足够的空间
   - 部分网站可能对下载速度或次数有限制
   - 对于加密视频，确保密钥文件可访问

3. **TS分片合并失败**：
   - 确保已安装FFmpeg并位于正确位置
   - 检查TS分片是否全部下载成功
   - 部分TS分片可能损坏或无法访问

4. **程序崩溃或无响应**：
   - 确保已安装所有依赖库
   - 尝试关闭其他占用资源较多的程序
   - 对于大型视频，下载过程可能需要较长时间，请耐心等待

5. **FFmpeg命令卡住**：
   - 本工具已优化FFmpeg命令执行，避免命令卡住的问题
   - 如遇到此问题，请确保使用最新版本的可执行文件

## 📝 更新日志

### v1.5.0（最新版本）
- **核心功能**：
  - 修复FFmpeg命令执行卡住的问题，优化进程管理
  - 添加下载状态管理模块，支持断点续传
  - 实现日志记录系统，自动保存下载日志到文件
  - 优化TS分片合并逻辑，提高合并成功率
- **性能优化**：
  - 优化FFmpeg命令执行方式，使用DEVNULL避免输出缓冲区阻塞
  - 改进进程管理，确保FFmpeg进程正确终止
  - 优化错误处理，提高程序稳定性
- **用户体验**：
  - 改进日志输出，提供更详细的下载信息
  - 优化进度显示，提供更直观的下载状态
  - 增强状态管理，支持下载任务恢复

### v1.4.0
- **核心功能**：
  - 将开始探测按钮改为自动下载按钮
  - 增加删除已成功下载网址的功能
  - 增加手动下载按钮
  - 实现下载状态实时更新
  - 实现下载历史记录，避免重复下载
  - 优化自动下载逻辑：优先getmovie链接，其次唯一m3u8文件，否则标记为手动下载
- **性能优化**：
  - 为每个URL创建独立的浏览器实例，避免状态冲突
  - 增强错误处理，确保程序稳定性
  - 优化FFmpeg进程管理，避免进程泄漏
- **用户体验**：
  - 改进URL列表管理，支持批量操作
  - 增强日志输出，提供更详细的下载信息
  - 优化进度显示，提供更直观的下载状态

### v1.3.0
- 添加对getmovie链接的支持，自动解析JSON响应提取M3U8链接
- 实现本地密钥文件处理，使用Resources目录中的密钥文件解密视频
- 自动删除使用后的密钥文件，提高安全性
- 优化JSON数据解析和错误处理
- 改进浏览器模拟和网络请求处理
- 修复TS分片合并失败的问题
- 增强加密相关信息的GUI控制台显示

### v1.2.0
- 完善依赖检查和安装流程
- 优化TS分片下载和合并过程
- 增强错误处理和日志记录
- 改进用户界面体验

### v1.1.0
- 添加Enter键快捷操作
- 优化控制台输出信息
- 改进进度显示，以分片个数为单位
- 增强临时文件管理功能
- 优化程序关闭机制

### v1.0.0
- 初始化项目
- 实现基本的视频爬取和下载功能
- 支持TS分片自动合并
- 构建PyQt5 GUI界面

## 📄 许可证

本项目采用MIT许可证，详见LICENSE文件。

## 🤝 贡献

欢迎提交Issue和Pull Request，帮助改进这个项目！

## 📞 联系

如果您有任何问题或建议，请随时联系我们。

---

**注意**：本工具仅用于学习和研究目的，请勿用于非法用途。使用本工具下载的视频资源请遵守相关法律法规，尊重版权所有者的权益。