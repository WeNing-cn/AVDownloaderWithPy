# 视频爬取下载工具
## 📄 法律声明
### 版权信息
- 本程序仅用于个人学习和研究目的
- 请勿用于商业用途或非法活动
### 使用条款
- 使用本程序即表示您同意遵守相关法律法规
- 程序开发者不对因使用本程序而产生的任何后果负责
- 请尊重视频版权，仅下载您有权使用的内容

使用Python开发的网站视频下载工具，支持对网站动态视频资源的爬取与本地保存功能，特别支持M3U8播放列表的TS分片自动合并。

Zip下载:
- 为了方便用户使用，我们提供了打包好的可执行文件（AVDownloader.exe）
- 您可以直接下载并运行该文件，无需安装任何依赖
- 请确保您的计算机满足系统要求（Windows 10及以上版本）
链接：https://github.com/WeNing-cn/AVDownloaderWithPy/raw/refs/heads/main/AVDownloader/zipped/AVD.zip

## 项目结构

```
AVDownloaderWithQTCpp/
├── AVDownloader/             # 源代码目录
│   ├── main.py                # 主程序入口
│   ├── browser_simulator.py   # 浏览器模拟模块
│   ├── video_detector.py      # 视频资源探测模块
│   ├── video_downloader.py    # 视频下载模块
│   ├── ts_merger.py           # TS分片合并模块
│   ├── utils.py               # 工具函数
│   ├── decrypt_existing.py    # 现有TS文件解密工具
│   ├── build_exe.py           # 打包脚本
│   ├── build_exe_simple.py    # 简单打包脚本
│   ├── test_browser.py        # 浏览器测试脚本
│   ├── test_ts_download.py    # TS下载测试脚本
│   └── requirements.txt       # 依赖库配置
├── dist/                      # 打包输出目录
│   ├── AVDownloader.exe       # 可执行文件
│   ├── Resources/             # 资源目录
│   │   └── ChromeSetup.exe    # Chrome安装程序
│   ├── Utils/                 # 工具目录
│   │   └── ffmpeg.exe         # FFmpeg工具
│   └── 用户须知.txt           # 用户使用说明
└── README.md                  # 项目说明
```

## 核心功能

### 🎯 主要功能
1. **直观的用户界面**：基于PyQt5构建的现代化界面，包含网址输入框、保存路径选择、视频列表、控制台输出区域和进度条
2. **智能视频资源探测**：使用浏览器模拟器加载页面，支持从HTML和JavaScript中提取视频链接，特别支持M3U8播放列表
3. **多格式视频下载**：支持普通视频文件和M3U8播放列表的下载
4. **TS分片自动合并**：自动下载、解密和合并TS格式视频分片，生成完整的MP4视频文件
5. **实时进度显示**：以分片个数为单位显示下载进度，更直观地反映下载状态
6. **临时文件管理**：自动检测和处理临时下载文件，支持合并和删除操作
7. **自动依赖管理**：自动检查Chrome浏览器和FFmpeg工具，缺失时提供安装指导

### ⚡ 特色功能
1. **Enter键快捷操作**：在URL输入框中按Enter键自动开始探测
2. **详细的控制台输出**：显示探测和下载的详细步骤，便于问题排查
3. **优雅的关闭机制**：在下载过程中关闭程序时，会安全停止所有操作
4. **并行下载优化**：使用线程池并行下载TS分片，提高下载速度
5. **断点续传支持**：支持视频文件的断点续传功能

## 技术实现

### 🔧 核心技术
- **GUI框架**：PyQt5，构建现代化的用户界面
- **浏览器模拟**：使用requests库模拟浏览器行为，支持JavaScript渲染和动态资源加载
- **视频资源识别**：开发视频链接识别算法，支持提取页面中的视频标签、source标签、iframe标签和JavaScript中的视频链接
- **并行处理**：使用concurrent.futures.ThreadPoolExecutor实现多线程并行下载
- **视频处理**：使用FFmpeg工具合并TS分片为完整的MP4文件
- **依赖管理**：自动检查和安装Chrome浏览器，确保程序正常运行

### 📡 网络处理
- **HTTP请求**：使用requests库发送HTTP请求，支持自定义 headers 和 cookies
- **会话管理**：保持浏览器会话状态，支持登录后的视频资源访问
- **重定向处理**：自动处理HTTP重定向，确保正确获取最终的视频URL
- **超时设置**：为网络请求设置合理的超时时间，提高程序稳定性

### 📦 文件处理
- **文件命名**：采用时间戳格式命名下载的视频文件
- **目录管理**：自动创建和管理临时目录，确保文件结构清晰
- **文件校验**：检查下载文件的完整性，确保视频文件可以正常播放
- **临时文件清理**：在程序退出时自动清理临时文件，避免磁盘空间浪费

## 安装与运行

### 🚀 快速启动
1. **下载打包版本**：直接运行 `dist/AVDownloader.exe`
2. **首次运行**：程序会自动检查Chrome浏览器和FFmpeg工具
3. **Chrome安装**：如果未安装Chrome，程序会自动启动安装流程
4. **FFmpeg检查**：确保 `Utils/ffmpeg.exe` 存在

### 🔧 从源码运行
1. **安装依赖**：
   ```bash
   pip install -r AVDownloader\requirements.txt
   ```

2. **运行程序**：
   ```bash
   python AVDownloader\main.py
   ```

### 📦 打包程序
1. **运行打包脚本**：
   ```bash
   python AVDownloader\build_exe_simple.py
   ```

2. **打包结果**：
   - 生成的可执行文件位于 `dist/AVDownloader.exe`
   - 包含必要的资源文件和工具

## 使用方法

### 🎯 基本操作
1. **输入目标网址**：在"目标网址"输入框中输入视频网站的URL
2. **开始探测**：点击"开始探测"按钮或按Enter键，程序会自动加载页面并探测视频资源
3. **查看视频列表**：探测完成后，视频资源会显示在左侧的视频资源列表中
4. **选择视频**：点击选择要下载的视频
5. **开始下载**：点击"下载选中视频"按钮开始下载
6. **查看进度**：底部进度条会显示下载进度，控制台输出区域会实时显示详细信息
7. **下载完成**：下载完成后，会弹出提示框显示下载结果

### ⚙️ 高级操作
1. **修改保存路径**：点击"浏览"按钮选择视频文件的保存位置
2. **处理临时文件**：程序启动时会检测临时下载文件，可选择合并或删除
3. **解密TS文件**：对于加密的TS文件，可以提供原始的M3U8 URL进行解密

## 注意事项

### ⚠️ 依赖要求
1. **Chrome浏览器**：用于浏览器模拟和页面加载
2. **FFmpeg工具**：用于TS分片合并，必须位于 `Utils/ffmpeg.exe`

### 🔒 安全提示
1. **网络连接**：确保网络连接稳定，避免下载过程中网络中断
2. **网站限制**：部分网站可能对视频下载有限制，如需要登录、验证码等，本工具可能无法处理这些情况
3. **权限问题**：确保程序有足够的权限访问保存路径，避免因权限不足导致下载失败
4. **性能优化**：对于大型视频或多个TS分片的情况，下载时间可能较长，请耐心等待

### 🐛 常见问题
1. **无法探测到视频资源**：
   - 检查URL是否正确
   - 确保网络连接正常
   - 部分网站可能使用了加密或特殊的视频播放方式，本工具可能无法识别

2. **下载失败**：
   - 检查网络连接是否稳定
   - 确保保存路径有足够的空间
   - 部分网站可能对下载速度或次数有限制

3. **TS分片合并失败**：
   - 确保已安装FFmpeg并位于正确位置
   - 检查TS分片是否全部下载成功
   - 部分TS分片可能损坏或无法访问

4. **程序崩溃或无响应**：
   - 确保已安装所有依赖库
   - 尝试关闭其他占用资源较多的程序
   - 对于大型视频，下载过程可能需要较长时间，请耐心等待

## 技术原理

### 📚 工作流程
1. **浏览器模拟**：使用requests库发送HTTP请求，模拟浏览器行为，获取页面内容
2. **视频资源探测**：解析HTML结构和JavaScript代码，提取视频链接和M3U8播放列表
3. **视频下载**：
   - 对于普通视频：直接下载完整文件
   - 对于M3U8播放列表：解析播放列表，下载所有TS分片
4. **TS分片处理**：
   - 下载所有TS分片
   - 如需解密，使用从M3U8获取的密钥解密
   - 使用FFmpeg合并TS分片为完整的MP4文件
5. **进度监控**：实时更新下载进度，显示分片下载状态
6. **完成处理**：清理临时文件，显示下载结果

### 🎯 核心模块
1. **MainWindow**：主窗口类，负责界面管理和用户交互
2. **SyncBrowserSimulator**：浏览器模拟器，负责加载页面和提取视频资源
3. **VideoDetector**：视频检测器，负责识别和提取视频链接
4. **VideoDownloader**：视频下载器，负责下载普通视频文件
5. **TSMerger**：TS合并器，负责下载和合并TS分片
6. **WorkerThread**：工作线程，负责在后台执行耗时操作

## 开发环境

### 🛠️ 环境要求
- Python 3.7+
- PyQt5 5.15.10
- requests 2.31.0
- beautifulsoup4 4.12.2
- ffmpeg-python 0.2.0
- tqdm 4.66.1

### 📁 开发工具
- PyCharm 或 VS Code：Python开发环境
- PyInstaller：用于打包可执行文件
- FFmpeg：用于视频处理

## 许可证

本项目采用MIT许可证，详见LICENSE文件。

## 免责声明

本工具仅用于学习和研究目的，请勿用于非法用途。使用本工具下载的视频资源请遵守相关法律法规，尊重版权所有者的权益。

## 更新日志

### v1.0.0
- 初始化项目
- 实现基本的视频爬取和下载功能
- 支持TS分片自动合并
- 构建PyQt5 GUI界面

### v1.1.0
- 添加Enter键快捷操作
- 优化控制台输出信息
- 改进进度显示，以分片个数为单位
- 增强临时文件管理功能
- 优化程序关闭机制

### v1.2.0
- 完善依赖检查和安装流程
- 优化TS分片下载和合并过程
- 增强错误处理和日志记录
- 改进用户界面体验
