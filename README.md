# AVDownloader - 视频爬取下载工具

## 📄 法律声明

### 版权信息
- 本程序仅用于个人学习和研究目的
- 请勿用于商业用途或非法活动

### 使用条款
- 使用本程序即表示您同意遵守相关法律法规
- 程序开发者不对因使用本程序而产生的任何后果负责
- 请尊重视频版权，仅下载您有权使用的内容

---

## 📖 项目简介

AVDownloader是一款功能强大的视频爬取下载工具，支持对网站动态视频资源的自动爬取与本地保存。特别支持M3U8播放列表的TS分片自动合并、getmovie链接的处理以及批量URL下载管理。

### ✨ 主要特性

- **🤖 自动下载模式**：一键自动探测并下载视频资源，支持智能重试机制
- **📝 批量URL管理**：支持批量添加多个网址，每行一个URL，自动验证格式
- **🔄 智能重试机制**：下载失败自动重试3次，间隔500ms-1000ms随机时间
- **🎯 智能资源检测**：优先检测getmovie链接，其次检测唯一m3u8文件
- **📊 实时状态更新**：下载失败或成功时立即更新状态，详细日志记录
- **📜 下载历史记录**：避免重复下载已下载的网址
- **👆 手动下载选项**：对于复杂资源提供手动选择下载
- **🧩 TS分片处理**：自动下载、解密和合并TS格式视频分片
- **🖥️ 直观的用户界面**：基于PyQt5构建的现代化界面
- **📝 日志记录系统**：详细记录下载过程和错误信息到文件
- **⏸️ 断点续传支持**：支持下载中断后恢复任务
- **🔒 Chrome进程管理**：自动管理浏览器进程，防止残留
- **✅ URL验证机制**：自动验证URL格式和网络可访问性

---

## 📁 项目结构

```
AVDownloaderWithQTCpp/
├── AVDownloader/                 # 源代码目录
│   ├── main.py                   # 主程序入口
│   ├── browser_simulator.py      # 浏览器模拟模块（支持上下文管理器）
│   ├── video_detector.py         # 视频资源探测模块
│   ├── video_downloader.py       # 视频下载模块
│   ├── ts_merger.py              # TS分片合并模块（增强日志记录）
│   ├── utils.py                  # 工具函数
│   ├── decrypt_existing.py       # 现有TS文件解密工具
│   ├── download_state_manager.py # 下载状态管理模块
│   ├── build_exe.py              # 打包脚本
│   ├── build_exe_simple.py       # 简单打包脚本
│   ├── test_browser.py           # 浏览器测试脚本
│   ├── test_ts_download.py       # TS下载测试脚本
│   ├── requirements.txt          # 依赖库配置
│   └── Resources/                # 资源目录
│       ├── logs/                 # 日志文件目录
│       │   └── downloader.log    # 下载日志文件
│       ├── ChromeSetup.exe       # Chrome安装程序
│       └── download_state.ini    # 下载状态配置文件
├── dist/                         # 打包输出目录
│   └── AVDownloader.exe          # 可执行文件
├── README.md                     # 项目说明
├── LICENSE.md                    # 许可证文件
└── .gitignore                    # Git忽略配置
```

---

## 🚀 快速开始

### 📦 下载压缩包（推荐）

**快捷下载地址**：
- **GitHub Releases**: 
https://raw.githubusercontent.com/WeNing-cn/AVDownloaderWithPy/refs/heads/main/AVDownloader/zipped/AVD.zip
下载后解压到任意目录，双击 `AVDownloader.exe` 即可运行。

### 直接运行

1. **下载打包版本**：从 `dist/AVDownloader.exe` 直接运行
2. **首次运行**：程序会自动检查Chrome浏览器和FFmpeg工具
3. **Chrome安装**：如果未安装Chrome，程序会自动启动安装流程
4. **FFmpeg检查**：确保 `Utils/ffmpeg.exe` 存在

### 从源码运行

1. **安装依赖**：
   ```bash
   pip install -r AVDownloader\requirements.txt
   ```

2. **运行程序**：
   ```bash
   python AVDownloader\main.py
   ```

### 打包程序

1. **运行打包脚本**：
   ```bash
   cd AVDownloader
   python build_exe.py
   ```

2. **打包结果**：
   - 生成的可执行文件位于 `dist/AVDownloader.exe`
   - 包含必要的资源文件和工具

---

## 🎯 核心功能详解

### 1. URL列表管理

- **📥 批量添加URL**：支持多行输入，每行一个URL，自动验证格式
- **🗑️ 删除URL**：选中URL后点击"删除"按钮
- **🧹 清空列表**：点击"清空"按钮清空所有URL
- **✅ 删除已成功**：点击"删除已成功"按钮删除所有下载成功的URL
- **🔍 重复检测**：自动检测并跳过重复的URL

### 2. 自动下载模式（增强版）

**智能资源检测流程**：
1. **优先检测getmovie链接**：如有则使用特殊解密方法下载
2. **其次检测唯一m3u8文件**：如有则自动下载
3. **否则标记为手动下载**：需要用户手动选择

**自动重试机制**：
- 下载失败时自动重试3次
- 每次重试间隔500ms-1000ms（随机时间，避免被识别）
- 每次重试重新获取最新的动态资源链接
- 详细记录每次重试的状态

**URL预处理**：
- 自动验证所有URL格式
- 检查URL网络可访问性
- 过滤无效链接

### 3. 手动下载功能

- **👆 手动选择**：对于复杂资源，可手动选择要下载的视频资源
- **🎛️ 灵活控制**：用户可以根据需要选择适合的视频质量和格式

### 4. 视频处理

- **🧩 TS分片合并**：自动下载、解密和合并TS格式视频分片
- **🎬 格式转换**：使用FFmpeg将TS分片合并为完整的MP4文件
- **🔐 加密处理**：支持从网络或本地资源目录获取密钥解密加密视频

### 5. 进度与状态管理

- **📊 实时进度**：底部进度条显示下载进度
- **📝 详细日志**：控制台输出区域显示详细的下载信息
- **🏷️ 状态显示**：每个URL旁边显示当前下载状态
- **📄 日志文件**：自动记录下载日志到 `Resources/logs/downloader.log`
- **⏸️ 断点续传**：支持下载中断后恢复任务

### 6. Chrome进程管理

- **🧹 自动清理**：程序退出时自动终止所有Chrome进程
- **🔄 上下文管理**：使用`with`语句确保浏览器正确关闭
- **🛡️ 析构函数**：对象销毁时自动关闭浏览器

---

## 🛠️ 技术实现

### 核心技术栈

| 技术 | 用途 |
|------|------|
| **PyQt5** | 构建现代化的用户界面 |
| **Selenium + Chrome** | 浏览器模拟和动态资源加载 |
| **concurrent.futures** | 多线程并行下载TS分片 |
| **FFmpeg** | TS分片合并为MP4 |
| **requests** | HTTP请求和密钥获取 |
| **pycryptodome** | AES-128解密加密视频 |

### 核心模块

1. **MainWindow**：主窗口类，负责界面管理和用户交互
2. **SyncBrowserSimulator**：浏览器模拟器，支持上下文管理器
3. **BrowserSimulator**：底层浏览器模拟，支持析构自动关闭
4. **VideoDetector**：视频检测器，识别和提取视频链接
5. **VideoDownloader**：视频下载器，下载普通视频文件
6. **TSMerger**：TS合并器，下载、解密和合并TS分片（增强日志）
7. **DownloadStateManager**：下载状态管理器，支持断点续传
8. **WorkerThread**：工作线程，后台执行耗时操作

---

## 📖 使用指南

### 基本操作流程

1. **📥 批量添加URL**：点击"添加"按钮，在弹出的对话框中批量粘贴视频网址（每行一个）
2. **📂 设置保存路径**：点击"浏览"按钮选择视频文件的保存位置
3. **🚀 开始自动下载**：点击"自动下载"按钮，程序会自动处理列表中的所有URL
4. **👀 查看下载状态**：观察URL列表中的状态显示，了解每个URL的下载情况
5. **🧹 清理已成功下载**：点击"删除已成功"按钮，清理已下载完成的URL
6. **👆 手动下载**：对于标记为需要手动下载的URL，点击"手动下载"按钮进行处理

### 高级功能

1. **📋 批量添加URL**：支持一次性粘贴多个URL，每行一个
2. **🔄 自动重试**：下载失败时自动重试3次，无需手动干预
3. **📜 下载历史管理**：程序会自动记录已下载的URL，避免重复下载
4. **🗂️ 临时文件处理**：程序启动时检测临时下载文件，可选择合并或删除
5. **🔐 加密视频处理**：自动从网络或本地资源目录获取密钥进行解密
6. **📝 日志管理**：自动记录下载日志，方便排查问题

---

## ⚠️ 注意事项

### 依赖要求

1. **Chrome浏览器**：用于Selenium浏览器模拟和页面加载
2. **FFmpeg工具**：用于TS分片合并，必须位于 `Utils/ffmpeg.exe`
3. **Python 3.7+**：用于运行源代码

### 安全提示

1. **网络连接**：确保网络连接稳定，避免下载过程中网络中断
2. **网站限制**：部分网站可能对视频下载有限制，本工具可能无法处理这些情况
3. **权限问题**：确保程序有足够的权限访问保存路径和资源目录
4. **性能优化**：对于大型视频或多个TS分片的情况，下载时间可能较长，请耐心等待
5. **版权尊重**：请遵守相关法律法规，尊重视频版权，仅下载您有权使用的内容

### 常见问题

#### 1. 无法探测到视频资源
- 检查URL是否正确
- 确保网络连接正常
- 部分网站可能使用了加密或特殊的视频播放方式，本工具可能无法识别

#### 2. 下载失败（已增强重试机制）
- 程序会自动重试3次，无需手动干预
- 检查网络连接是否稳定
- 确保保存路径有足够的空间
- 查看日志文件了解详细错误信息

#### 3. TS分片合并失败
- 确保已安装FFmpeg并位于正确位置
- 检查TS分片是否全部下载成功
- 部分TS分片可能损坏或无法访问

#### 4. 程序崩溃或无响应
- 确保已安装所有依赖库
- 尝试关闭其他占用资源较多的程序
- 对于大型视频，下载过程可能需要较长时间，请耐心等待

#### 5. Chrome进程残留
- 本版本已修复Chrome进程残留问题
- 程序退出时会自动清理所有Chrome进程
- 如遇到残留进程，重启程序或手动结束chrome.exe进程

---

## 📝 更新日志

### v1.6.0（最新版本 - 2026-02-09）

#### 🆕 新增功能
- **自动重试机制**：下载失败时自动重试3次，间隔500ms-1000ms随机时间
- **批量URL添加**：支持多行输入，每行一个URL，自动验证格式
- **URL预处理**：自动验证所有URL格式和网络可访问性
- **视频资源验证**：自动过滤无效的视频资源链接
- **Chrome进程管理**：添加析构函数和上下文管理器，防止进程残留
- **增强日志记录**：TS分片下载过程详细记录到日志文件

#### 🔧 修复问题
- **修复缩进错误**：修复getmovie链接检测的缩进问题，确保正确遍历所有资源
- **修复链接读取**：确保逐个读取并处理所有视频链接
- **修复进程残留**：程序退出时自动清理Chrome进程

#### ⚡ 性能优化
- **随机重试间隔**：使用500ms-1000ms随机间隔，避免被服务器识别为机器人
- **动态资源刷新**：每次重试重新获取最新的动态资源链接
- **内存管理优化**：改进浏览器实例的生命周期管理

---

### v1.5.0

#### 🆕 新增功能
- **下载状态管理模块**：支持断点续传
- **日志记录系统**：自动保存下载日志到文件
- **FFmpeg进程管理优化**：避免命令卡住

#### 🔧 修复问题
- **FFmpeg命令执行**：使用DEVNULL避免输出缓冲区阻塞
- **进程终止**：确保FFmpeg进程正确终止

---

### v1.4.0

#### 🆕 新增功能
- **自动下载按钮**：一键自动探测并下载
- **删除已成功功能**：清理已下载完成的URL
- **手动下载按钮**：支持复杂资源的手动选择
- **下载状态实时更新**：实时显示下载进度

#### 🔧 修复问题
- **浏览器实例管理**：为每个URL创建独立的浏览器实例
- **错误处理增强**：确保程序稳定性

---

### v1.3.0

#### 🆕 新增功能
- **getmovie链接支持**：自动解析JSON响应提取M3U8链接
- **本地密钥文件处理**：使用Resources目录中的密钥文件解密视频

#### 🔧 修复问题
- **TS分片合并**：修复合并失败的问题
- **加密信息显示**：增强GUI控制台显示

---

### v1.2.0
- 完善依赖检查和安装流程
- 优化TS分片下载和合并过程
- 增强错误处理和日志记录

---

### v1.1.0
- 添加Enter键快捷操作
- 优化控制台输出信息
- 改进进度显示，以分片个数为单位
- 增强临时文件管理功能
- 优化程序关闭机制

---

### v1.0.0
- 初始化项目
- 实现基本的视频爬取和下载功能
- 支持TS分片自动合并
- 构建PyQt5 GUI界面

---

## 📄 许可证

本项目采用MIT许可证，详见LICENSE文件。

## 🤝 贡献

欢迎提交Issue和Pull Request，帮助改进这个项目！

## 📞 联系

如果您有任何问题或建议，请随时联系我们。

---

**注意**：本工具仅用于学习和研究目的，请勿用于非法用途。使用本工具下载的视频资源请遵守相关法律法规，尊重版权所有者的权益。
